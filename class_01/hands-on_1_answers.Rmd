---
title: "Transform Data"
subtitle: "hands-on examples, with answers"
output: html_notebook
---

<!-- This file by Charlotte Wickham (with some modifications by Martin Monkman) is licensed under a Creative Commons Attribution 4.0 International License, adapted from the orignal work at https://github.com/rstudio/master-the-tidyverse by RStudio. -->

```{r setup}
library(tidyverse)
library(gapminder)

```

# Transform Data 1: manipulate cases


## gapminder

Take a quick look at the data in the {gapminder} package.

```{r}
gapminder
```

## Your Turn 1: filter() rows

See if you can use the logical operators to manipulate our code below to show:

The data for Canada

```{r}
# example
filter(gapminder, country == "New Zealand")

# answer
filter(gapminder, country == "Canada")

```

All data for countries in Oceania

```{r}
# example
filter(gapminder, country == "New Zealand")

# answer
filter(gapminder, continent == "Oceania")
```

Rows where the life expectancy is greater than 82
```{r}
# example
filter(gapminder, country == "New Zealand")

# answer
filter(gapminder, lifeExp > 82)
```


## Your Turn 2: multiple criteria

Use Boolean operators to alter the code below to return only the rows that contain:

* United States before 1970

```{r}
# example 
gapminder %>%                                       # Note use of `%>%` pipe symbol
  filter(country == "New Zealand", year > 2000)

# answer
gapminder %>%
  filter(country == "United States", year < 1970)

# alternative answer
gapminder %>%
  filter(country == "United States" & year < 1970)  # Note use of `&` rather than comma

```

*  Countries where life expectancy in 2007 is below 50 or over 75

```{r}
# answer
gapminder %>%
  filter(year == 2007, lifeExp < 50 | lifeExp > 75) # Note that you have to state `lifeExp` twice, as
                                                    # there are two comparisons.
                                                    # What happens if you replace the comma after 2007 with `&`?
                                                    # - Why do you think this might be happening?



```



* Create a list object and return records for any of "New Zealand", "Canada" or "United States"


```{r}
# answer
gapminder %>%
  filter(country %in% c("New Zealand", "Canada", "United States"))
  
# alternate answer
country_list <- c("New Zealand", "Canada", "United States")   # create object that is list of countries
gapminder %>%
  filter(country %in% country_list)                           # filter uses that object 
  

```

* Return records for all continents except Europe


```{r}
# answer
gapminder %>%
  filter(continent != "Europe")
  
# answer with a double-check
gapminder %>%
  filter(continent != "Europe") %>%
  distinct(continent)                 # the `distinct()` function returns the list of all the 
                                      # continent names after the filter is applied

```

## Your Turn 3: sorting with `arrange()`

Find the records with the smallest population.
```{r}
#answer
gapminder %>%
  arrange(pop)

```

Find the records with the largest GDP per capita.
```{r}
#answer
gapminder %>%
  arrange(desc(gdpPercap))

```


## Your Turn 4: creating new variables

Calculate a new variable with total GDP

```{r, error = TRUE}
# answer
gapminder %>%
  mutate(totalGDP = pop * gdpPercap)


```

Create a summary table with the population and GDP by continent for the year 1952  

```{r}
# answer
gapminder %>%
  filter(year == 1952) %>%               # filter to get the records we need
  mutate(totalGDP = pop * gdpPercap) %>% # note that we need to add the new variable calculated above!
  group_by(continent) %>%                # this defines the grouping category
  summarize(pop = sum(pop),              # 
            totalGDP = sum(totalGDP))    #
```




## Your Turn 5

Alter the code to add a `prev_lifeExp` column that contains the life expectancy from the previous record.

(Hint: use "Transformation" cheatsheet, you want to offset elements by one)

Extra challenge: Why isn't this quite the 'life expectency five years ago'?

```{r}
# answer
gapminder %>%
  mutate(prev_lifeExp = lag(lifeExp))

# challenge hint: 
# - note that there is an `NA` in the first row, since there's no prior row to pull from
# - look at the `prev_lifeExp` when the country changes from Afghanistan to Albania 
```


***

# Take aways

* Extract cases with `filter()`  
* Filter using a list with `%in%`
* Make new variables, with `mutate()`  
* Connect operations with `%>%`  
