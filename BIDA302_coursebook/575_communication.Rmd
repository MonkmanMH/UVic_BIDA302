<!-- 
This file by Martin Monkman 
is licensed under a Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/  

-->

```{r echo = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE, cache = TRUE)
options(width = 100, dplyr.width = 100)
```

# Communication {#communication}



## Reading & reference  {#communication-reading}

Garrett Grolemund and Hadley Wickham, [R for Data Science](https://r4ds.had.co.nz/)

* ["Communication" section](https://r4ds.had.co.nz/communicate-intro.html), Chapters 26 "Introduction" to 29 "R Markdown formats"


**Colours in plotting**

[R color cheatsheet](https://www.nceas.ucsb.edu/sites/default/files/2020-04/colorPaletteCheatsheet.pdf)



**R Markdown**

Yihui Xie, Christophe Dervieux, Emily Riederer, ["The kableExtra package", _R Markdown Cookbook_](https://bookdown.org/yihui/rmarkdown-cookbook/kableextra.html)



Packages:

**flextable**

* {flextable} - [flextable R package reference](https://davidgohel.github.io/flextable/index.html)

* David Gohel, [flextable book](https://ardata-fr.github.io/flextable-book/)


**kableExtra**

* Hao Zhu, [Create Awesome HTML Table with knitr::kable and kableExtra](https://haozhu233.github.io/kableExtra/awesome_table_in_html.html)

* Hao Zhu, [Using kableExtra in Bookdown](https://haozhu233.github.io/kableExtra/bookdown/index.html)

* Yihui Xie, Christophe Dervieux, Emily Riederer, ["The kableExtra package", _R Markdown Cookbook_](https://bookdown.org/yihui/rmarkdown-cookbook/kableextra.html)

* [KableExtra Tutorial](https://rstudio-pubs-static.s3.amazonaws.com/444395_76727eaf9c774fa8bf932bed16500a00.html)


## Plot formatting {#communication-plot}

In the chapters [@data_viz] and [@data_viz_2], we started to explore some ways to format our plots. One of the great things about the {ggplot2} package is that it provides virtually infinite ways to make our already-good plots even better. Here are some ways to do that.



### Annotations

The scatterplot we made in [@moneyball] is interesting in and of itself. But with some annotations, some of the details can be made explicit.

One way to do that is to add lines to a plot that create sections to the plot. In the example in the previous chapter, vertical line and horizontal lines were added by using `geom_vline()` and `geom_hline()`. 

As you will recall, the red line runs vertically at the "1" point on the X axis. The teams to the left of the line spent below the league average for that season; the teams to the right spent more. As you can see, there have been cases when some teams spent twice as much as the league average. The blue line runs horizontally at the "0.5" point on the Y axis. Above this line, the teams won more games than they lost. Below the line, they lost more games than they won.


```{r}

mlb_pay_wl <- read_csv("data/mlb_pay_wl.csv", 
                       col_types = 
                         cols(year_num = col_character()))

# create plot object for repeated use
moneyball_plot <- ggplot(mlb_pay_wl, aes(x = pay_index, y = w_l_percent)) + 
  geom_point() 

moneyball_plot +
  geom_vline(xintercept  = 100, colour = "red", size = 2) +
  geom_hline(yintercept = 0.5, colour = "blue", size = 2)

```

Another option would have been to add a block of shading for the "Moneyball" teams that spent below the league average, but had winning seasons. For this, the `annotate("rect")` is used. The fill colour is hex code for the specific shade of green used by the Oakland Athletics, as found at [usteamcolors.com](https://usteamcolors.com/oakland-athletics-team-colors/). (See [_R Graphics Cookbook_, 2nd ed.](https://r-graphics.org/recipe-annotate-rect) for applications of this in a line plot.)


```{r}
moneyball_plot +
  annotate("rect", xmin = 0, xmax = 100, ymin = 0.5, ymax = 0.8,
           alpha = .3, fill = "#003831")

```


Another way to tell the "Moneyball" story would be to identify the Oakland Athletics in the mass of dots shown, by using color. The code is in two steps:

* first, create a subset of the main table that is only the Oakland data points

* redraw the plot, adding a new `geom_point()` layer. Note that the colour used is now the yellow-gold in the Athletic's colour scheme, and the size of the points is specified to be slightly larger than the others.

```{r}

oakland <- mlb_pay_wl %>% 
  filter(tm == "OAK")

moneyball_plot +
  geom_point(data = oakland, aes(x = pay_index, y = w_l_percent),
             colour = "#efb21e", size = 2)

```

We might want to make other changes in this plot—for example, using a different colour for the other points, so that the Oakland ones are more clearly differentiated.

### Text labels

Another type of annotation is to use text. For the example below, the names of the top teams are added to the 2002 season data (the year in which the _Moneyball_ story is set). First, filter for 2002.

The next step is to identify the teams at the extremes of each quadrant—top winners and biggest losers in the above- and below-average spending teams. For this, we will use the `mutate()` function to add a new variable, based on the other values, using the `case_when()` function.

```{r}

mlb_2002 <- mlb_pay_wl %>% 
  filter(year_num == 2002)

# add salary group
mlb_2002 <- mlb_2002 %>% 
  mutate(salary_grp = case_when(
    pay_index >= 100 ~ "above",
    pay_index < 100 ~ "below"
  ))


# add quadrant
mlb_2002 <- mlb_2002 %>% 
  mutate(team_quad = case_when(
    pay_index >= 100 & w_l_percent >= 0.5 ~ "I",
    pay_index < 100 & w_l_percent >= 0.5 ~ "II",
    pay_index < 100 & w_l_percent < 0.5 ~ "III",
    pay_index >= 100 & w_l_percent < 0.5 ~ "IV"
  ))

team_for_label <- mlb_2002 %>% 
  group_by(salary_grp) %>% 
  filter(w_l_percent == max(w_l_percent) |
         w_l_percent == min(w_l_percent))

team_for_label

```


Note that we end up with five teams in the list, since Detroit ("DET") and Tampa Bay ("TBD") ended up with identical win-loss records.

We can now use the team names from that table as annotations, using `geom_text`. 

```{r}

# the same plot as before, but with just the 2002 teams
ggplot(mlb_2002, aes(x = pay_index, y = w_l_percent)) + 
  geom_point() +
  # add the names from the "team_for_label" table
  geom_text(data = team_for_label, aes(label = tm))

```

This isn't entirely satisfactory, since the labels overlie the points. In the version below, the `geom_label()` is used instead, along with the `nudge_x` argument to move the label slightly to the left of the point (that is, -6 units on the x-axis—and yes, I experimented a bit to find the right nudge!).


```{r}

# the same plot as before, but with just the 2002 teams
ggplot(mlb_2002, aes(x = pay_index, y = w_l_percent)) + 
  geom_point() +
  # add horizontal and vertical lines
  geom_vline(xintercept  = 100, colour = "grey") +
  geom_hline(yintercept = 0.5, colour = "grey") +
  # add the names from the "team_for_label" table
  geom_label(data = team_for_label, aes(label = tm),
             nudge_x = -6)

```

For another example of this sort of labeling, see [_R for Data Science_, "Graphics for Communication: Annotations"](https://r4ds.had.co.nz/graphics-for-communication.html#annotations).


### Colour palettes

There are many pre-defined colour palettes available when plotting in {ggplot2}. 

(The {ggplot2} reference page that covers this is under "Scales" https://ggplot2.tidyverse.org/reference/index.html#section-scales))

An important thing to recognize (and this took me a long time to figure out!) is that how you specify the palette needs to match the type of variable that's being represented by the colour. In general, they are either _discrete_ (categories, such as factors or character strings) or _continuous_ (a range of numbers).

First, let's add "year_num" as a colour variable to a subset of our Moneyball plot. 

**Important:**  In this example, "year_num" is a specified as a "character" variable, it is therefore a discrete variable—but beware: if it had been read as a numeric variable, it would be continuous!

```{r}
mlb_pay_wl %>% 
  filter(year_num > "2014") %>% 
  ggplot(aes(x = pay_index, y = w_l_percent, color = year_num)) + 
  geom_point()

```

We can change the default palette in a number of ways. Below, we use one of the "ColorBrewer" palettes. These palettes are designed for discrete scales on maps, but they translate well to data plotting. There are palettes for sequential, diverging, and qualitative colour scales.

A valuable reference is at [_R Graphics  Cookbook_, 2nd ed., "Using a Different Palette for a Discrete Variable"](https://r-graphics.org/recipe-colors-palette-discrete), which includes the names and images of a variety of palettes.

(See also http://colorbrewer2.org.)

And for even more information about the use of colorbrewer.org scales, see this page at the {ggplot} reference: https://ggplot2.tidyverse.org/reference/scale_brewer.html 



```{r}

mlb_pay_wl %>% 
  filter(year_num > "2014") %>% 
  ggplot(aes(x = pay_index, y = w_l_percent, colour = year_num)) + 
  geom_point() +
  # add ColorBrewer palette
  scale_colour_brewer(palette = "Set1")


```



In the plots below, the average attendance is plotted as a colour aesthetic. Average attendance is a _continuous_ variable, so we need to make sure our palette can represent that type.


The "ColorBrewer" palettes, while designed for discrete scales, can be adapted to a continuous scale (as we have here) by using one of the `distiller` scales, which interpolate the values between the discrete colours in the original scale.

```{r}
ggplot(mlb_pay_wl, aes(x = pay_index, y = w_l_percent, color = attend_g)) + 
  geom_point() +
  scale_color_distiller(palette = "Greens")

```


Another option is to use one of the `viridis` palettes. Note that in this case, the default scale has the largest value plotted as the lightest colour, which seems counter-intuitive to me, so I have added the `direction = -1` argument to the `scale_color_viridis_c()` function.


```{r}
ggplot(mlb_pay_wl, aes(x = pay_index, y = w_l_percent, color = attend_g)) + 
  geom_point() +
  scale_color_viridis_c(direction = -1)

```

For more information about the `viridis` palettes, see [_R Graphics Cookbook_, 2nd ed, "Using Colors in Plots: Using a Colorblind-Friendly Palette"](https://r-graphics.org/chapter-colors)


## Table formatting {#communication-table}

The look of the default table in R markdown is not all that attractive. Here's a summary table of the Oakland Athletics' seasons from 1999-2008.

```{r}

oakland_99 <- mlb_pay_wl %>% 
  filter(tm == "OAK" & year_num < 2009)

oakland_99
```

There are a few R packages that allow us to format a table like this, ready for publication. Here we will take a quick look at two of them. Both have many, many more options for formatting; see the reference materials at the top of this chapter for those details.

First, {kableExtra} is an extension to the {kable} tool that is part of "knitting" our R Markdown files.

```{r}
library(kableExtra)

# print table with {kableExtra} formatting  
oakland_99 %>%
  # create table, add title
  kable(caption = "Oakland Athletics, 1999-2008") %>%
  kable_styling(bootstrap_options = "striped", font_size = 10) %>%
  # make variable names bold and large
  row_spec(0, bold = T, font_size = 14) %>%
  # make 2002 season (row 4) bold
  row_spec(4, bold = T) 
```  


Another table formating package is {flextable}. 


```{r}
library(flextable)

oakland_99 %>% 
  flextable() %>% 
  add_footer_row(values = "Source: baseball-reference.com", colwidths = 8)

```


-30-
