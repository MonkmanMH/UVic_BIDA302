---
title: "Classic Rock 25 - sales data"
output: html_notebook
---

This script uses data from Walt Hickey's article [Why Classic Rock Isnâ€™t What It Used To Be](https://fivethirtyeight.com/features/why-classic-rock-isnt-what-it-used-to-be/) (FiveThirtyEight, 2014-07-07)

Data is available through [GitHub](https://github.com/fivethirtyeight/data/tree/master/classic-rock)




```{r setup}
library(tidyverse)
library(lubridate)

library(glue)
```


## Read data

```{r}

albumlist <- read_csv("classic_rock_25_538.csv")
albumlist
```

## _add price, accurate genre_


## Generate customer (store) ID table

Note: store list is defunct record retailers, active in the 80s and 90s, from [Wikipedia List of defunct Canadian companies](https://en.wikipedia.org/wiki/List_of_defunct_Canadian_companies#Consumer_retail,_including_grocery)

* HMV was left off, as it was an international brand that was late to the market

```{r}
storelist <- read_csv("storelist.csv")

storelist

storelist %>%
  group_by(region) %>%
  tally()
  
```

## Create order

### order date

https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html

```{r}
jan01 <- ymd("2019-01-01")
startdate <- as_date(floor_date(jan01, "year"))
enddate <- as_date(ceiling_date(jan01, "year") - days(1))
daterange <- tibble(orderdate = as_date(c(startdate:enddate)))

orderdate_fun <- function(){ 
daterange %>%
  sample_n(1) %>%
  pull(orderdate) 
}  

# set the size of the order based on year quarter
# - same number of orders but biggest in 4th quarter, smallest in 1st
# - value sets the mean value of poisson distribution from which random value is pulled
order_mean_fun <- function(orderdate){
  order_qtr <- quarter(orderdate)
  order_mean <- case_when(
    order_qtr == 1 ~ 4,
    order_qtr == 4 ~ 6,
    TRUE ~ 5
  )
}
```


```{r}
# function to randomly select the store
store_fun <- function(){ 
storelist %>%
  sample_n(1) %>%
  pull(store.id) 
}  

#store.id <- store_fun()

```



### album_order_fun

```{r}
album_order_fun <- function(...){
  sample_n(albumlist, 1, weight = pct_plays) %>%
    select(artist, album, price) %>%
  mutate(format = sample(c("lp", "cass"), 1, prob = c(0.33, 0.67)),
         qty = rpois(1, 4)
  )
#         ,
#         orderdate = `orderdate`, 
#         store.id = `store.id`)
}
# TEST
#album_order_fun()
```


### multiples

```{r}
# TEST
n = rpois(1, 7)
order_final <- data.frame(artist = as.character(),
                          album = as.character(),
                          price = as.double(),
                          format = as.character(),
                          qty = as.integer(),
#                          orderdate = as_date(as.character()),
#                          store.id = as.character(),
                          stringsAsFactors = FALSE)  
#ls.str(order_final)
#rbind(order_final, order_fun())
#
for(i in 1:n){
  order_final[i, ] <- album_order_fun()
}
order_final
```

test orderdate and order_mean 

```{r}
orderdate <- orderdate_fun()
orderdate
order_mean <- order_mean_fun(orderdate)
order_mean
```

```{r}
order_fun_1 <- function(){
  n = rpois(1, 5)
  order_final <- data.frame(artist = as.character(),
                          album = as.character(),
                          price = as.double(),
                          format = as.character(),
                          qty = as.integer(),
#                          orderdate = as_date(as.character()),
#                          store.id = as.character(),
                          stringsAsFactors = FALSE)  
  
  for(i in 1:n){
    order_final[i, ] <- album_order_fun()
  }
  order_final
  }


#TEST 
order_fun_1()
```




```{r}
# now with order date and store id appended after the run

order_fun <- function(){
  
  orderdate <- orderdate_fun()

  order_mean <- order_mean_fun(orderdate)
  n = rpois(1, order_mean)
  
  store.id <- store_fun()
  
  order_final <- data.frame(artist = as.character(),
                          album = as.character(),
                          price = as.double(),
                          format = as.character(),
                          qty = as.integer(),
#                          orderdate = as_date(as.character()),
#                          store.id = as.character(),
                          stringsAsFactors = FALSE)  
  
  for(i in 1:n){
    order_final[i, ] <- album_order_fun()
  }
  order_final <- order_final %>%
    mutate(orderdate = orderdate,
           store.id = store.id)
  
  order_final
  }
```


```{r}
order_fun()
```


Now a run of multiple orders...

```{r}



order_multi <- data.frame(artist = as.character(),
                          album = as.character(),
                          price = as.double(),
                          format = as.character(),
                          qty = as.integer(),
                          orderdate = as_date(as.character()),
                          store.id = as.character(),
                          stringsAsFactors = FALSE)  
  
  for(i in 1:n){
    order_multi[i, ] <- order_fun()
  }
  order_multi
  }


```




# next!

* nest this inside a tibble with the store.id and date fields

https://tidyr.tidyverse.org/reference/nest.html

https://rstudio-education.github.io/tidyverse-cookbook/transform-tables.html 





* next that inside a bigger object



