---
title: "R in data analysis - an example"
subtitle: "New Housing Price Index"
author: "Martin Monkman"
output: html_notebook
---

This set of scripts creates summary tables and graphs plotting the New Housing Price Index (NHPI) data collected and reported by Statistics Canada.

The original source code, created by Martin Monkman with contributions by Julie Hawkins and Stephanie Yurchak, can be found here:  https://github.com/bcgov/CANSIM-dataviewer/blob/master/scr/NHPI_cansim.Rmd

### Setup

```{r setup}
# tidyverse
library(tidyverse)
library(lubridate)  # date functions
library(scales)     # extending {ggplot2}
#
# utilities
library(cansim)     # data extract
#library(janitor)
```

---

### Import


**data source**

[The Daily, 2019-10-10](https://www150.statcan.gc.ca/n1/daily-quotidien/191010/dq191010a-eng.htm)

Table: 18-10-0205-01 (formerly CANSIM  327-0056)
https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810020501 



```{r}
#thedata <- read_csv("../data/03270056-eng.csv")

# This version (updated 2018-12-13) uses the `cansim` package to pull the data from CANSIM.

table_id = "18-10-0205-01"

thedata <- get_cansim(table_id)
thedata <- thedata %>%
    mutate(REF_DATE = ymd(REF_DATE, truncated = 2)) 
get_cansim_table_overview(table_id)
thedata
```


### Tidy


#### understand what's in the data frame

geography list

```{r}
thedata %>%
  group_by(GEO, GeoUID) %>%
  tally()
```





```{r}
startdate <- as.Date("2007-01-01")
# filter to have BC and Canada
thedata_long <- thedata %>%
  filter(REF_DATE >= startdate) %>%
  filter(GEO %in% c("British Columbia", "Canada"), 
         `New housing price indexes` == "Total (house and land)")
thedata_long
```


---

### Visualize - tables



## Data table - example


```{r}
startdate <- as.Date("2007-01-01")
# filter to have BC and Canada
thedata_table <- thedata %>%
  filter(REF_DATE >= startdate) %>%
  filter(GEO == "British Columbia", 
         `New housing price indexes` == "Total (house and land)")
thedata_table
```


```{r}

NHPI_table <- thedata_table %>%
  mutate(year = year(REF_DATE),
         month = month(REF_DATE, label = TRUE)) %>%
  select(year, month, VALUE) %>%
  pivot_wider(names_from = month, values_from = VALUE)
NHPI_table

```



```{r}
# how to add annual average
# Julie's genius solution
NHPI_table2 <- NHPI_table %>%
  mutate(annual_avg = rowMeans(NHPI_table[-1], na.rm = TRUE))
NHPI_table2
```



```{r}
# Stephanie's genius solution
NHPI_table3 <- thedata_table %>%
  mutate(year = year(REF_DATE),
         month = month(REF_DATE, label = TRUE)) %>%
  select(year, month, VALUE) %>%
  group_by(year) %>%
  mutate(annual_avg = mean(VALUE, na.rm = TRUE)) %>%
  spread(month, VALUE)
NHPI_table3
```

--- 

### Visualize - plot


```{r}
# PLOT!
# basic
ggplot(thedata_long, aes(x=REF_DATE, y=VALUE, group=GEO)) + 
  geom_line()
#
# with formatting applied
dataplot <- ggplot(thedata_long, aes(x=REF_DATE, y=VALUE, colour=GEO)) + 
  geom_line(size=1.5) 
dataplot
```

with more formatting

```{r}
dataplot2 <- dataplot +
  #  ylim(3500000, 6500000) +
  scale_y_continuous(labels = comma, limits = c(80, 120)) +
  scale_colour_manual(name=NULL,
                      breaks=c("Canada", "British Columbia"),
                      labels=c("Canada", "British Columbia"), 
                      values=c("#325A80", "#CCB550")) +
  theme_bw() +
  theme(
    panel.border = element_rect(colour="white"),
    plot.title = element_text(face="bold"),
    legend.position=c(1,0), 
    legend.justification=c(1,0),
    legend.title = element_text(size=12),
    legend.text = element_text(size=11),
    axis.line = element_line(colour="black"),
    axis.title = element_text(size=12),
    axis.text = element_text(size=12)
  )
#
dataplot2 
```

final version

```{r}
# experiments with ggplot2's new subtitle and caption options
NHPI_title <- as.character("New Housing Price Index, Canada & B.C.")
NHPI_subtitle <- as.character("December 2016 = 100")
NHPI_caption <- as.character("Source: Statistics Canada, CANSIM table 18-10-0205-01")
# add titles / X-Y axis labels
dataplot2 +
  ggtitle(NHPI_title, subtitle = NHPI_subtitle)
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title, subtitle = NHPI_subtitle)
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       x = NULL, y = "NHPI")
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI") 
# final version
# add titles / X-Y axis labels / caption
NHPI_plot <- dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI (Dec. 2016 = 100)") 
NHPI_plot
ggsave(filename = "NHPI_plot.png", plot = NHPI_plot,
       width = 8, height = 6)
```


***

### Vancouver house and land version



```{r}
startdate <- as.Date("2007-01-01")
# filter to have Vancouver
thedata_long <- thedata %>%
  filter(REF_DATE >= startdate) %>%
  filter(GEO %in% c("Vancouver, British Columbia"), 
         `New housing price indexes` %in% c("House only", "Land only"))
thedata_long
```

the plot

```{r}
# with formatting applied
dataplot <- ggplot(thedata_long, aes(x=REF_DATE, y=VALUE, 
                                     colour=`New housing price indexes`)) + 
  geom_line(size=1.5) 
dataplot
dataplot2 <- dataplot +
  #  ylim(3500000, 6500000) +
  scale_y_continuous(labels = comma, limits = c(80, 120)) +
  scale_colour_manual(name=NULL,
                      breaks=c("House only", "Land only"),
                      labels=c("House only", "Land only"), 
                      values=c("#325A80", "#CCB550")) +
  theme_bw() +
  theme(
    panel.border = element_rect(colour="white"),
    plot.title = element_text(face="bold"),
    legend.position=c(1,0), 
    legend.justification=c(1,0),
    legend.title = element_text(size=12),
    legend.text = element_text(size=11),
    axis.line = element_line(colour="black"),
    axis.title = element_text(size=12),
    axis.text = element_text(size=12)
  )
#
dataplot2 
# set chart titles and labels
NHPI_title <- as.character("New Housing Price Index, Vancouver: house and land")
NHPI_subtitle <- as.character("December 2016 = 100")
NHPI_caption <- as.character("Source: Statistics Canada, CANSIM table 18-10-0205-01")
# final version
# add titles / X-Y axis labels / caption
NHPI_Vancouver_plot <- dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI (Dec. 2016 = 100)") 
NHPI_Vancouver_plot
ggsave(filename = "NHPI_Vancouver_plot.png", plot = NHPI_Vancouver_plot,
       width = 8, height = 6)
```


