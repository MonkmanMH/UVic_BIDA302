---
title: "R in data analysis - an example"
subtitle: "New Housing Price Index"
author: "Martin Monkman"
output: html_notebook
---

This set of scripts creates summary tables and graphs plotting the New Housing Price Index (NHPI) data collected and reported by Statistics Canada.

The original source code, created by Martin Monkman with contributions by Julie Hawkins and Stephanie Yurchak, can be found here:  https://github.com/bcgov/CANSIM-dataviewer/blob/master/scr/NHPI_cansim.Rmd

### Setup

```{r setup}
# tidyverse
library(tidyverse)
library(lubridate)  # date functions
library(scales)     # extending {ggplot2}
#
# utilities
library(cansim)     # data extract
library(janitor)    # for `clean_names()`
```


functions

```{r functions}
get_mom_stats <- function(df) {
  
  df %>%
    arrange(ref_date) %>%
    mutate(mom_val = lag(value), 
           mom_pct = ((value / lag(value, n = 1)) - 1) * 100,
           mom_chg = (value - lag(value, n = 1)))
}


get_yoy_stats <- function(df) {
  
  df %>%
    arrange(ref_date) %>%
    mutate(yoy_val = lag(value, n = 12),
           yoy_pct = ((value / lag(value, n = 12)) - 1) * 100,
           yoy_chg = (value - lag(value, n = 12)))
}
```

---

### Import


**data source**

[The Daily, 2019-10-10](https://www150.statcan.gc.ca/n1/daily-quotidien/191010/dq191010a-eng.htm)

Table: 18-10-0205-01 (formerly CANSIM  327-0056)
https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1810020501 



```{r}
#thedata <- read_csv("../data/03270056-eng.csv")

# This version (updated 2018-12-13) uses the `cansim` package to pull the data from CANSIM.

table_id = "18-10-0205-01"

thedata <- get_cansim(table_id)

thedata <- janitor::clean_names(thedata)

thedata <- thedata %>%
    mutate(ref_date = ymd(ref_date, truncated = 2)) 
get_cansim_table_overview(table_id)
thedata
```


### Tidy


#### understand what's in the data frame

geography list

```{r}
thedata %>%
  group_by(geo, geo_uid) %>%
  tally()
```



#### BC & Canada data

```{r}
startdate <- as.Date("2007-01-01")

# filter to have BC and Canada
thedata_long <- thedata %>%
  filter(ref_date >= startdate) %>%
  filter(geo %in% c("British Columbia", "Canada"), 
         new_housing_price_indexes == "Total (house and land)") %>%
  select(ref_date, geo, new_housing_price_indexes, value)

thedata_long
```


Add month-over-month and year-over-year values

```{r}

thedata_long <- thedata_long %>%
  group_by(geo, new_housing_price_indexes) %>%
  get_mom_stats() %>%
  get_yoy_stats %>%
  ungroup() %>%
  arrange(geo, ref_date)

thedata_long
```


---

### Visualize - tables



#### table - months as columns



```{r}

NHPI_table <- thedata_long %>%
  filter(geo == "British Columbia") %>%
  mutate(year = year(ref_date),
         month = month(ref_date, label = TRUE)) %>%
  select(year, month, value) %>%
  pivot_wider(names_from = month, values_from = value) %>%
  arrange(desc(year))
NHPI_table

```



```{r}
# how to add annual average
# Julie's genius solution
NHPI_table2 <- NHPI_table %>%
  mutate(annual_avg = rowMeans(NHPI_table[-1], na.rm = TRUE))
NHPI_table2
```




```{r}
# Stephanie's genius solution
# starts with the raw data table
NHPI_table3 <- thedata_table %>%
  mutate(year = year(ref_date),
         month = month(ref_date, label = TRUE)) %>%
  select(year, month, value) %>%
  group_by(year) %>%
  mutate(annual_avg = mean(value, na.rm = TRUE)) %>%
  pivot_wider(names_from = month, values_from = value) %>%
  arrange(desc(year))
NHPI_table3
```

#### table: current month


--- 

### Visualize - plot


```{r}
# PLOT!
# basic
ggplot(thedata_long, aes(x=ref_date, y=value, group=geo)) + 
  geom_line()
#
# with formatting applied
dataplot <- ggplot(thedata_long, aes(x=ref_date, y=value, colour=geo)) + 
  geom_line(size=1.5) 
dataplot
```

with more formatting

```{r}
dataplot2 <- dataplot +
  #  ylim(3500000, 6500000) +
  scale_y_continuous(labels = comma, limits = c(80, 120)) +
  scale_colour_manual(name=NULL,
                      breaks=c("Canada", "British Columbia"),
                      labels=c("Canada", "British Columbia"), 
                      values=c("#325A80", "#CCB550")) +
  theme_bw() +
  theme(
    panel.border = element_rect(colour="white"),
    plot.title = element_text(face="bold"),
    legend.position=c(1,0), 
    legend.justification=c(1,0),
    legend.title = element_text(size=12),
    legend.text = element_text(size=11),
    axis.line = element_line(colour="black"),
    axis.title = element_text(size=12),
    axis.text = element_text(size=12)
  )
#
dataplot2 
```

final version

```{r}
# experiments with ggplot2's new subtitle and caption options
NHPI_title <- as.character("New Housing Price Index, Canada & B.C.")
NHPI_subtitle <- as.character("December 2016 = 100")
NHPI_caption <- as.character("Source: Statistics Canada, CANSIM table 18-10-0205-01")
# add titles / X-Y axis labels
dataplot2 +
  ggtitle(NHPI_title, subtitle = NHPI_subtitle)
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title, subtitle = NHPI_subtitle)
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       x = NULL, y = "NHPI")
# add titles / X-Y axis labels
dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI") 
# final version
# add titles / X-Y axis labels / caption
NHPI_plot <- dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI (Dec. 2016 = 100)") 
NHPI_plot
ggsave(filename = "NHPI_plot.png", plot = NHPI_plot,
       width = 8, height = 6)
```


***

### Vancouver house and land version



```{r}
startdate <- as.Date("2007-01-01")
# filter to have Vancouver
thedata_long <- thedata %>%
  filter(ref_date >= startdate) %>%
  filter(geo %in% c("Vancouver, British Columbia"), 
         new_housing_price_indexes %in% c("House only", "Land only"))
thedata_long
```

the plot

```{r}
# with formatting applied
dataplot <- ggplot(thedata_long, aes(x=ref_date, y=value, 
                                     colour=new_housing_price_indexes)) + 
  geom_line(size=1.5) 
dataplot
dataplot2 <- dataplot +
  #  ylim(3500000, 6500000) +
  scale_y_continuous(labels = comma, limits = c(80, 120)) +
  scale_colour_manual(name=NULL,
                      breaks=c("House only", "Land only"),
                      labels=c("House only", "Land only"), 
                      values=c("#325A80", "#CCB550")) +
  theme_bw() +
  theme(
    panel.border = element_rect(colour="white"),
    plot.title = element_text(face="bold"),
    legend.position=c(1,0), 
    legend.justification=c(1,0),
    legend.title = element_text(size=12),
    legend.text = element_text(size=11),
    axis.line = element_line(colour="black"),
    axis.title = element_text(size=12),
    axis.text = element_text(size=12)
  )
#
dataplot2 
# set chart titles and labels
NHPI_title <- as.character("New Housing Price Index, Vancouver: house and land")
NHPI_subtitle <- as.character("December 2016 = 100")
NHPI_caption <- as.character("Source: Statistics Canada, CANSIM table 18-10-0205-01")
# final version
# add titles / X-Y axis labels / caption
NHPI_Vancouver_plot <- dataplot2 +
  labs(title = NHPI_title,
       subtitle = NHPI_subtitle,
       caption = NHPI_caption, 
       x = NULL, y = "NHPI (Dec. 2016 = 100)") 
NHPI_Vancouver_plot
ggsave(filename = "NHPI_Vancouver_plot.png", plot = NHPI_Vancouver_plot,
       width = 8, height = 6)
```


