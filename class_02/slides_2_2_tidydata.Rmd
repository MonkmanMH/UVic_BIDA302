---
title: "Tidy data"
subtitle: "with {tidyr}"
author: "BIDA302 - lesson 2"
date: "2019/11/09"
output:
  xaringan::moon_reader:
    css: ["default", "css_files/eigengrau.css", "css_files/eigengrau-fonts.css"]    
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

# Martin Monkman
---


```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)

library(tidyverse)

```

class: inverse

# Tidy data

> “Happy families are all alike; every unhappy family is unhappy in its own way.” –– Leo Tolstoy

>“Tidy datasets are all alike, but every messy dataset is messy in its own way.” –– Hadley Wickham



---

# Principles of tidy data

### 1. Each variable must have its own column.

### 2. Each observation must have its own row.

### 3. Each value must have its own cell.




--


![tidy principles](../img/tidy-1.png)

???

From [_R for Data Science_, "Tidy Data"](https://r4ds.had.co.nz/tidy-data.html)


---

## Untidy data: example


```{r}
#tidyr::relig_income
print(tidyr::relig_income, n=5)

```

--

It's untidy because it violates Principle #1: the income variable is spread across 10 columns

???

from {tidyr}; see https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html 


---

To make it tidy, we need to pivot it into a longer form:

```{r}
tidyr::relig_income %>%
  pivot_longer(-religion, names_to = "income_cat", values_to = "count")
```

---

You can see this type of table structure a lot...

It is often used to present summary tables that will be read by humans

_find another example...BC Stats?_


---
## Is this data tidy?

```{r echo=FALSE}
# Elections Canada October 21, 2019 Federal Election Results
# https://enr.elections.ca/National.aspx?lang=e
# sourced 2019-11-06
CDN_elec_2019 <- tibble(party = c("Liberal", "Conservative", "Bloc Québécois", "New Democratic", "Green", "Independent"),
                        seats = c(157, 121, 32, 24, 3, 1),
                        votes = c(5915950, 6155662, 1376135, 2849214, 1162361, 75836))
# hahaha! It's easier to make a tidy tibble and untidy it than make a messy one to start with
CDN_elec_2019 <- CDN_elec_2019 %>%
  pivot_longer(-party, names_to = "category", values_to = "number")
CDN_elec_2019
```

--

It violiates Principles #1 & #2--there are two variables (seats and votes) combined into one column, and there are two rows (seats and rows) for each observation (in this case, party)

_Sometimes untidy data can be too long!_

---

To tidy the table, we need to `pivot_wider()`

```{r}
CDN_elec_2019 %>%
  pivot_wider(names_from = category, values_from = number)
```


---

## Multiple observations per row

```{r echo=FALSE}

family <- tribble(
  ~family,  ~dob_child1,  ~dob_child2, ~gender_child1, ~gender_child2,
       1L, "1998-11-26", "2000-01-29",             1L,             2L,
       2L, "1996-06-22",           NA,             2L,             NA,
       3L, "2002-07-11", "2004-04-05",             2L,             2L,
       4L, "2004-10-10", "2009-08-27",             1L,             1L,
       5L, "2000-12-05", "2005-02-28",             2L,             1L,
)
family <- family %>% mutate_at(vars(starts_with("dob")), parse_date)
family

```

???

source: https://tidyr.tidyverse.org/articles/pivot.html

---

* in `names_to`, there are two things in the c():
  - `".value"` sets part of the column name is the associated with the value (e.g. "dob" is 1998-11-26)
  - then the second part of the name becomes the value of the "child" variable
* use `names_sep` to specify where the split happens

```{r}

family %>% 
  pivot_longer(
    -family, 
    names_to = c(".value", "child"), 
    names_sep = "_"
  )

family %>% 
  pivot_longer(
    -family, 
    names_to = c(".value", "child"), 
    names_sep = "_"
  )

```


---

And with the NA row omitted...

```{r}

family %>% 
  pivot_longer(
    -family, 
    names_to = c(".value", "child"), 
    names_sep = "_", 
    values_drop_na = TRUE
  )

```

